name: Create branch from issue

on:
  issues:
    types: [ opened ]

permissions:
  contents: write
  issues: write

jobs:
  create_branch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract issue details and determine branch type
        id: extract
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          
          # Get issue labels
          LABELS=$(gh api repos/${{ github.repository }}/issues/$ISSUE_NUMBER --jq '.labels[].name' | tr '\n' ' ')
          echo "Issue labels: $LABELS"
          
          # Define label to branch mapping
          BRANCH_TYPE="feature"  # default
          BASE_BRANCH="develop"  # default
          
          if echo "$LABELS" | grep -q "feature"; then
            BRANCH_TYPE="feature"
            BASE_BRANCH="develop"
          elif echo "$LABELS" | grep -q "hotfix"; then
            BRANCH_TYPE="hotfix"
            BASE_BRANCH="main"
          elif echo "$LABELS" | grep -q "bug"; then
            BRANCH_TYPE="bugfix"
            BASE_BRANCH="develop"
          elif echo "$LABELS" | grep -q "enhancement"; then
            BRANCH_TYPE="refactor"
            BASE_BRANCH="develop"
          elif echo "$LABELS" | grep -q "config"; then
            BRANCH_TYPE="internal"
            BASE_BRANCH="develop"
          fi
          
          echo "branch_type=$BRANCH_TYPE" >> $GITHUB_OUTPUT
          echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT

      - name: Create branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.extract.outputs.issue_number }}
          BRANCH_TYPE: ${{ steps.extract.outputs.branch_type }}
          BASE_BRANCH: ${{ steps.extract.outputs.base_branch }}
        run: |
          BRANCH_NAME="$BRANCH_TYPE/EXSHAPP-$(printf "%04d" $ISSUE_NUMBER)"

          echo "Creating branch $BRANCH_NAME from $BASE_BRANCH"

          gh api \
            repos/${{ github.repository }}/git/refs \
            -X POST \
            -f ref="refs/heads/$BRANCH_NAME" \
            -f sha=$(gh api repos/${{ github.repository }}/git/refs/heads/$BASE_BRANCH -q .object.sha)

      - name: Link branch to issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.extract.outputs.issue_number }}
          BRANCH_TYPE: ${{ steps.extract.outputs.branch_type }}
        run: |
          BRANCH_NAME="$BRANCH_TYPE/EXSHAPP-$(printf "%04d" $ISSUE_NUMBER)"
          
          echo "Linking branch $BRANCH_NAME to issue #$ISSUE_NUMBER"
          
          # Create a comment on the issue to link the branch
          gh issue comment $ISSUE_NUMBER --body "üå± **Branch created:** \`$BRANCH_NAME\`

          This branch has been automatically created for this issue. You can now:
          - Switch to this branch: \`git checkout $BRANCH_NAME\`
          - Push changes to this branch to work on this issue
          - Create a pull request when ready

          The branch was created from \`${{ steps.extract.outputs.base_branch }}\` based on the issue labels."

      - name: Create draft PR to link issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.extract.outputs.issue_number }}
          BRANCH_TYPE: ${{ steps.extract.outputs.branch_type }}
          BASE_BRANCH: ${{ steps.extract.outputs.base_branch }}
        run: |
          BRANCH_NAME="$BRANCH_TYPE/EXSHAPP-$(printf "%04d" $ISSUE_NUMBER)"
          
          # Get issue title for PR title
          ISSUE_TITLE=$(gh issue view $ISSUE_NUMBER --json title --jq '.title')
          
          # Create draft PR with proper issue reference
          gh pr create \
            --head "$BRANCH_NAME" \
            --base "$BASE_BRANCH" \
            --title "[EXSHAPP-$(printf "%04d" $ISSUE_NUMBER)]: $ISSUE_TITLE" \
            --body "## üìã Issue Reference

          Closes #$ISSUE_NUMBER

          ## üìù Description

          This pull request addresses the issue described in #$ISSUE_NUMBER.

          ### üîÑ Changes Made
          - [ ] TODO: Add your changes here

          ### ‚úÖ Testing
          - [ ] TODO: Describe how you tested these changes

          ### üìö Additional Notes
          - This PR was automatically created from the issue
          - Please update this description with your actual changes
          - Remove this template text when ready" \
            --draft
          
          echo "‚úÖ Draft PR created and linked to issue #$ISSUE_NUMBER"
