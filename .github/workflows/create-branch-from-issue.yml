name: Create branch from issue

on:
  issues:
    types: [ opened ]

permissions:
  contents: write
  issues: read

jobs:
  create_branch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract issue details and determine branch type
        id: extract
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          
          # Get issue labels
          LABELS=$(gh api repos/${{ github.repository }}/issues/$ISSUE_NUMBER --jq '.labels[].name' | tr '\n' ' ')
          echo "Issue labels: $LABELS"
          
          # Define label to branch mapping
          BRANCH_TYPE="feature"  # default
          BASE_BRANCH="develop"  # default
          
          if echo "$LABELS" | grep -q "feature"; then
            BRANCH_TYPE="feature"
            BASE_BRANCH="develop"
          elif echo "$LABELS" | grep -q "hotfix"; then
            BRANCH_TYPE="hotfix"
            BASE_BRANCH="main"
          elif echo "$LABELS" | grep -q "bug"; then
            BRANCH_TYPE="bugfix"
            BASE_BRANCH="develop"
          elif echo "$LABELS" | grep -q "enhancement"; then
            BRANCH_TYPE="refactor"
            BASE_BRANCH="develop"
          elif echo "$LABELS" | grep -q "config"; then
            BRANCH_TYPE="internal"
            BASE_BRANCH="develop"
          fi
          
          echo "branch_type=$BRANCH_TYPE" >> $GITHUB_OUTPUT
          echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT

      - name: Create branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.extract.outputs.issue_number }}
          BRANCH_TYPE: ${{ steps.extract.outputs.branch_type }}
          BASE_BRANCH: ${{ steps.extract.outputs.base_branch }}
        run: |
          BRANCH_NAME="$BRANCH_TYPE/EXSHAPP-$(printf "%04d" $ISSUE_NUMBER)"

          echo "Creating branch $BRANCH_NAME from $BASE_BRANCH"

          gh api \
            repos/${{ github.repository }}/git/refs \
            -X POST \
            -f ref="refs/heads/$BRANCH_NAME" \
            -f sha=$(gh api repos/${{ github.repository }}/git/refs/heads/$BASE_BRANCH -q .object.sha)

      - name: Link branch to issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.extract.outputs.issue_number }}
          BRANCH_TYPE: ${{ steps.extract.outputs.branch_type }}
        run: |
          BRANCH_NAME="$BRANCH_TYPE/EXSHAPP-$(printf "%04d" $ISSUE_NUMBER)"
          
          echo "Linking branch $BRANCH_NAME to issue #$ISSUE_NUMBER"
          
          # Create a development branch reference for the issue
          gh api \
            repos/${{ github.repository }}/issues/$ISSUE_NUMBER/development \
            -X POST \
            -f branch_name="$BRANCH_NAME"
