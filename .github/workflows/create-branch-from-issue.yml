name: Create branch from issue

on:
  issues:
    types: [ opened ]

permissions:
  contents: write
  issues: write

jobs:
  create_branch:
    runs-on: ubuntu-latest
    steps:
      - name: Extract issue details and determine branch type
        id: extract
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          
          # 1. Get issue labels
          LABELS=$(gh api repos/${{ github.repository }}/issues/$ISSUE_NUMBER --jq '.labels[].name' | tr '\n' ' ')
          echo "Issue labels: $LABELS"
          
          # 2. Define label to branch mapping (defaults)
          BRANCH_TYPE="feature"
          BASE_BRANCH="develop"
          
          # 3. Determine branch type and base branch based on labels
          if echo "$LABELS" | grep -q "hotfix"; then
            BRANCH_TYPE="hotfix"
            BASE_BRANCH="main"
          elif echo "$LABELS" | grep -q "bug"; then
            BRANCH_TYPE="bugfix"
            BASE_BRANCH="develop"
          elif echo "$LABELS" | grep -q "enhancement"; then
            BRANCH_TYPE="refactor"
            BASE_BRANCH="develop"
          elif echo "$LABELS" | grep -q "config"; then
            BRANCH_TYPE="internal"
            BASE_BRANCH="develop"
          elif echo "$LABELS" | grep -q "feature"; then
            BRANCH_TYPE="feature"
            BASE_BRANCH="develop"
          fi
          
          echo "branch_type=$BRANCH_TYPE" >> $GITHUB_OUTPUT
          echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT

      - name: Check and Create branch
        id: create_ref
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.extract.outputs.issue_number }}
          BRANCH_TYPE: ${{ steps.extract.outputs.branch_type }}
          BASE_BRANCH: ${{ steps.extract.outputs.base_branch }}
        run: |
          BRANCH_NAME="$BRANCH_TYPE/EXSHAPP-$(printf "%04d" $ISSUE_NUMBER)"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

          # Check if the branch already exists in the remote
          # 'gh api' returns a non-zero exit status if it receives a 404 (not found)
          if gh api repos/${{ github.repository }}/git/ref/heads/$BRANCH_NAME > /dev/null 2>&1; then
            echo "‚ö†Ô∏è Branch $BRANCH_NAME already exists."
            echo "created=false" >> $GITHUB_OUTPUT
          else
            echo "üöÄ Creating branch $BRANCH_NAME from $BASE_BRANCH..."
          
            gh api \
              repos/${{ github.repository }}/git/refs \
              -X POST \
              -f ref="refs/heads/$BRANCH_NAME" \
              -f sha=$(gh api repos/${{ github.repository }}/git/refs/heads/$BASE_BRANCH -q .object.sha)
          
            echo "created=true" >> $GITHUB_OUTPUT
          fi

      - name: Comment on issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.extract.outputs.issue_number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          BRANCH_NAME: ${{ steps.create_ref.outputs.branch_name }}
          BASE_BRANCH: ${{ steps.extract.outputs.base_branch }}
          WAS_CREATED: ${{ steps.create_ref.outputs.created }}
        run: |
          # Prepare title format for the Pull Request
          TITLE_FORMAT="[EXSHAPP-$(printf "%04d" $ISSUE_NUMBER)]: $ISSUE_TITLE"
          
          # Build the message header based on whether the branch was created or already existed
          if [ "$WAS_CREATED" = "true" ]; then
            HEADER="üå± **Branch created:** \`$BRANCH_NAME\`"
            DESC="This branch has been automatically created for this issue."
          else
            HEADER="‚ö†Ô∏è **Branch already exists:** \`$BRANCH_NAME\`"
            DESC="A branch linked to this issue ID already exists. You can use it to continue working."
          fi

          # Use 'cat' with a heredoc (EOF) to safely handle special characters/quotes in the issue title
          cat <<EOF > comment_body.md
          $HEADER

          $DESC
          
          You can now:
          - Switch to this branch: \`git checkout $BRANCH_NAME\`
          - Push changes to this branch to work on this issue
          - **When creating your PR, use this title format:** \`$TITLE_FORMAT\`
          - **Add this to your PR description:** \`Closes #$ISSUE_NUMBER\`

          The branch is based on \`$BASE_BRANCH\`.

          üí° **Tip:** The PR title and description format above will automatically close this issue when merged!
          EOF

          # Post the comment to the issue
          gh issue comment $ISSUE_NUMBER -F comment_body.md
