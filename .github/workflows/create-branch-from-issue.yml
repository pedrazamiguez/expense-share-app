name: Create branch from issue

on:
  issues:
    types: [ opened ]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  create_branch:
    runs-on: ubuntu-latest
    steps:
      - name: Extract issue details and determine branch type
        id: extract
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          TITLE="${{ github.event.issue.title }}"
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "issue_title=$TITLE" >> $GITHUB_OUTPUT
          
          # 1. Get issue labels
          LABELS=$(gh api repos/${{ github.repository }}/issues/$ISSUE_NUMBER --jq '.labels[].name' | tr '\n' ' ')
          echo "Issue labels: $LABELS"
          
          # 2. Define label to branch mapping (defaults)
          BRANCH_TYPE="feature"
          BASE_BRANCH="develop"
          AUTO_PR="false"
          TARGET_BRANCH="develop"
          
          # 3. Determine branch type and base branch based on labels
          if echo "$LABELS" | grep -q "hotfix"; then
            BRANCH_TYPE="hotfix"
            BASE_BRANCH="main"
            TARGET_BRANCH="main"
            AUTO_PR="true"
          elif echo "$LABELS" | grep -q "release"; then
            BRANCH_TYPE="release"
            BASE_BRANCH="develop"
            TARGET_BRANCH="main"
            AUTO_PR="true"
          elif echo "$LABELS" | grep -q "bug"; then
            BRANCH_TYPE="bugfix"
            BASE_BRANCH="develop"
          elif echo "$LABELS" | grep -q "enhancement"; then
            BRANCH_TYPE="refactor"
            BASE_BRANCH="develop"
          elif echo "$LABELS" | grep -q "config"; then
            BRANCH_TYPE="internal"
            BASE_BRANCH="develop"
          elif echo "$LABELS" | grep -q "feature"; then
            BRANCH_TYPE="feature"
            BASE_BRANCH="develop"
          fi
          
          echo "branch_type=$BRANCH_TYPE" >> $GITHUB_OUTPUT
          echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT
          echo "auto_pr=$AUTO_PR" >> $GITHUB_OUTPUT
          echo "target_branch=$TARGET_BRANCH" >> $GITHUB_OUTPUT

      - name: Check and Create branch
        id: create_ref
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.extract.outputs.issue_number }}
          BRANCH_TYPE: ${{ steps.extract.outputs.branch_type }}
          BASE_BRANCH: ${{ steps.extract.outputs.base_branch }}
        run: |
          BRANCH_NAME="$BRANCH_TYPE/EXSHAPP-$(printf "%04d" $ISSUE_NUMBER)"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

          # Check if the branch already exists
          if gh api repos/${{ github.repository }}/git/ref/heads/$BRANCH_NAME > /dev/null 2>&1; then
            echo "‚ö†Ô∏è Branch $BRANCH_NAME already exists."
            echo "created=false" >> $GITHUB_OUTPUT
          else
            echo "üöÄ Creating branch $BRANCH_NAME from $BASE_BRANCH..."
          
            gh api \
              repos/${{ github.repository }}/git/refs \
              -X POST \
              -f ref="refs/heads/$BRANCH_NAME" \
              -f sha=$(gh api repos/${{ github.repository }}/git/refs/heads/$BASE_BRANCH -q .object.sha)
          
            echo "created=true" >> $GITHUB_OUTPUT
          fi

      # Automatically create PR for releases and hotfixes
      - name: Create Auto PR
        if: steps.create_ref.outputs.created == 'true' && steps.extract.outputs.auto_pr == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH_NAME: ${{ steps.create_ref.outputs.branch_name }}
          TARGET_BRANCH: ${{ steps.extract.outputs.target_branch }}
          TYPE: ${{ steps.extract.outputs.branch_type }}
          TITLE: ${{ steps.extract.outputs.issue_title }}
          ISSUE: ${{ steps.extract.outputs.issue_number }}
        run: |
          # Check if this is a release issue and if the "Major Release" checkbox is checked
          LABELS_ARG="--label $TYPE"
          
          if [ "$TYPE" = "release" ]; then
            ISSUE_BODY=$(gh api repos/${{ github.repository }}/issues/$ISSUE --jq '.body')
            # Check if the "Major Release (Breaking Changes)" checkbox is checked
            if echo "$ISSUE_BODY" | grep -q '\[x\][[:space:]]*Major Release (Breaking Changes)'; then
              echo "üî• Major release checkbox detected, adding 'major' label to PR"
              LABELS_ARG="$LABELS_ARG --label major"
            fi
          fi
          
          gh pr create \
            --repo ${{ github.repository }} \
            --base $TARGET_BRANCH \
            --head $BRANCH_NAME \
            --title "[EXSHAPP-$(printf "%04d" $ISSUE)]: $TITLE" \
            --body "Automated PR for $TYPE. Closes #$ISSUE" \
            $LABELS_ARG

      - name: Comment on issue
        # Comment when: (1) auto-PR is disabled (feature/bugfix branches), OR (2) branch already existed (so no auto-PR was created)
        if: steps.extract.outputs.auto_pr == 'false' || steps.create_ref.outputs.created == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.extract.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.extract.outputs.issue_title }}
          BRANCH_NAME: ${{ steps.create_ref.outputs.branch_name }}
          BASE_BRANCH: ${{ steps.extract.outputs.base_branch }}
          WAS_CREATED: ${{ steps.create_ref.outputs.created }}
        run: |
          TITLE_FORMAT="[EXSHAPP-$(printf "%04d" $ISSUE_NUMBER)]: $ISSUE_TITLE"
          
          if [ "$WAS_CREATED" = "true" ]; then
            HEADER="üå± **Branch created:** \`$BRANCH_NAME\`"
            DESC="This branch has been automatically created based on \`$BASE_BRANCH\`."
          else
            HEADER="‚ö†Ô∏è **Branch already exists:** \`$BRANCH_NAME\`"
            DESC="You can use it to continue working."
          fi

          cat <<EOF > comment_body.md
          $HEADER
          $DESC
          
          You can now:
          - Switch to this branch: \`git checkout $BRANCH_NAME\`
          - Push changes.
          - **When creating your PR, use this title:** \`$TITLE_FORMAT\`
          - **Add description:** \`Closes #$ISSUE_NUMBER\`
          EOF

          gh issue comment $ISSUE_NUMBER --repo ${{ github.repository }} -F comment_body.md
