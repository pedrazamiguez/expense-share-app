name: Sync main to develop & Bump Version

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  pull-requests: write

jobs:
  sync_and_bump:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Merge main into develop
        run: |
          git checkout develop
          git pull origin develop
          git merge origin/main --no-ff || {
            echo "âŒ Conflict detected while merging main into develop. Manual resolution required. Exiting workflow."
            git merge --abort
            exit 1 
          }

      - name: Bump Version for Next Dev Cycle
        id: bump
        run: |
          # Read version.properties from origin/main to get the correct base version
          git checkout origin/main -- version.properties
          MAJOR=$(grep '^versionMajor=' version.properties | cut -d'=' -f2 || echo "0")
          MINOR=$(grep '^versionMinor=' version.properties | cut -d'=' -f2 || echo "0")
          PATCH=$(grep '^versionPatch=' version.properties | cut -d'=' -f2 || echo "0")
          IS_SNAPSHOT=$(grep '^versionSnapshot=' version.properties | cut -d'=' -f2 || echo "false")

          # Validate extracted version numbers
          if ! [[ "$MAJOR" =~ ^[0-9]+$ ]]; then
            echo "âŒ Error: versionMajor is missing or not a valid integer."
            exit 1
          fi
          if ! [[ "$MINOR" =~ ^[0-9]+$ ]]; then
            echo "âŒ Error: versionMinor is missing or not a valid integer."
            exit 1
          fi
          if ! [[ "$PATCH" =~ ^[0-9]+$ ]]; then
            echo "âŒ Error: versionPatch is missing or not a valid integer."
            exit 1
          fi

          # Restore version.properties to the merged develop state
          git checkout develop -- version.properties
          if [ ! -f version.properties ]; then
            echo "âŒ Error: version.properties file not found."
            exit 1
          fi

          echo "Current version on main: $MAJOR.$MINOR.$PATCH (Snapshot: $IS_SNAPSHOT)"

          if [ "$IS_SNAPSHOT" == "false" ]; then
            NEW_MINOR=$((MINOR + 1))
            NEW_PATCH=0
          
            sed -i "s/^versionMinor=.*/versionMinor=$NEW_MINOR/" version.properties
            sed -i "s/^versionPatch=.*/versionPatch=$NEW_PATCH/" version.properties
            sed -i "s/^versionSnapshot=.*/versionSnapshot=true/" version.properties
          
            echo "ðŸš€ Bumped to next development version: $MAJOR.$NEW_MINOR.$NEW_PATCH-SNAPSHOT"
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Main seems to be a snapshot? This shouldn't happen in a strict flow, but skipping bump."
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Push changes
        if: steps.bump.outputs.changed == 'true'
        run: |
          git add version.properties
          git commit -m "chore: bump version to next minor snapshot [skip ci]"
          git push origin develop
