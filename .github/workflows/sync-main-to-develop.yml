name: Sync main to develop & Bump Version

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  pull-requests: write

jobs:
  sync_and_bump:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Prepare Backmerge Branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create a unique branch for the sync
          SYNC_BRANCH="sync/main-to-develop-${{ github.sha }}"
          
          # Checkout develop and create the sync branch
          git checkout develop
          git pull origin develop
          git checkout -b $SYNC_BRANCH
          
          echo "Sync branch created: $SYNC_BRANCH"
          
          # Merge main into the sync branch
          # Using --no-edit to accept default merge message if it's auto-mergeable
          # If there is a conflict, this command will fail and we handle it below
          if git merge origin/main --no-ff --no-edit; then
            echo "‚úÖ Merge successful."
          else
            echo "‚ö†Ô∏è Merge conflicts detected. Committing conflicts for manual resolution."
            # We continue execution to allow the PR to be created with conflicts
          fi

          # Read version.properties to calculate the next version
          # We read from the current state (merged)
          MAJOR=$(grep '^versionMajor=' version.properties | cut -d'=' -f2 || echo "0")
          MINOR=$(grep '^versionMinor=' version.properties | cut -d'=' -f2 || echo "0")
          PATCH=$(grep '^versionPatch=' version.properties | cut -d'=' -f2 || echo "0")
          IS_SNAPSHOT=$(grep '^versionSnapshot=' version.properties | cut -d'=' -f2 || echo "false")

          echo "Merged version state: $MAJOR.$MINOR.$PATCH (Snapshot: $IS_SNAPSHOT)"

          # Bump logic: If we just merged a Release (no snapshot), we prepare the next dev cycle
          if [ "$IS_SNAPSHOT" == "false" ]; then
            NEW_MINOR=$((MINOR + 1))
            NEW_PATCH=0
          
            sed -i "s/^versionMinor=.*/versionMinor=$NEW_MINOR/" version.properties
            sed -i "s/^versionPatch=.*/versionPatch=$NEW_PATCH/" version.properties
            sed -i "s/^versionSnapshot=.*/versionSnapshot=true/" version.properties
          
            echo "üöÄ Bumped to next development version: $MAJOR.$NEW_MINOR.$NEW_PATCH-SNAPSHOT"
          
            # Commit the bump
            git add version.properties
            git commit -m "chore: bump version to next minor snapshot [skip ci]" || echo "Nothing to commit"
          else
            echo "‚ÑπÔ∏è Main was already a snapshot or logic skipped. No bump needed."
          fi

          # Push the sync branch
          git push origin $SYNC_BRANCH

          # Create the Pull Request to develop
          gh pr create \
            --base develop \
            --head $SYNC_BRANCH \
            --title "Sync: Backmerge main to develop" \
            --body "Automated PR to sync release changes and bump version on develop. Please review and merge." \
            --label "sync"
