name: Sync main to develop & Bump Version

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  pull-requests: write

jobs:
  sync_and_bump:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Prepare Backmerge Branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create a unique branch for the sync
          SYNC_BRANCH="sync/main-to-develop-${{ github.sha }}"
          
          # Checkout develop and create the sync branch
          git checkout develop
          git pull origin develop
          git checkout -b $SYNC_BRANCH
          
          echo "Sync branch created: $SYNC_BRANCH"
          
          # Merge main into the sync branch
          # Using --no-edit to accept default merge message if it's auto-mergeable
          # If there is a conflict, this command will fail and we handle it below
          MERGE_FAILED=false
          if git merge origin/main --no-ff --no-edit; then
            echo "‚úÖ Merge successful."
          else
            echo "‚ö†Ô∏è Merge conflicts detected."
            MERGE_FAILED=true
          fi

          # Check for conflict markers in version.properties
          if grep -qE '(<<<<<<<|=======|>>>>>>>)' version.properties 2>/dev/null; then
            echo "üîß Resolving version.properties conflict automatically..."
          
            # Extract versions from both sides
            DEVELOP_MAJOR=$(git show HEAD:version.properties | grep '^versionMajor=' | cut -d'=' -f2)
            DEVELOP_MINOR=$(git show HEAD:version.properties | grep '^versionMinor=' | cut -d'=' -f2)
            DEVELOP_PATCH=$(git show HEAD:version.properties | grep '^versionPatch=' | cut -d'=' -f2)
          
            MAIN_MAJOR=$(git show origin/main:version.properties | grep '^versionMajor=' | cut -d'=' -f2)
            MAIN_MINOR=$(git show origin/main:version.properties | grep '^versionMinor=' | cut -d'=' -f2)
            MAIN_PATCH=$(git show origin/main:version.properties | grep '^versionPatch=' | cut -d'=' -f2)
          
            echo "Develop version: $DEVELOP_MAJOR.$DEVELOP_MINOR.$DEVELOP_PATCH"
            echo "Main version: $MAIN_MAJOR.$MAIN_MINOR.$MAIN_PATCH"
          
            # Compare versions: if develop is ahead, keep develop's version
            if [ "$DEVELOP_MINOR" -gt "$MAIN_MINOR" ] || \
               ([ "$DEVELOP_MINOR" -eq "$MAIN_MINOR" ] && [ "$DEVELOP_PATCH" -gt "$MAIN_PATCH" ]); then
              echo "‚úÖ Develop version is ahead (likely after a release). Keeping develop's version."
              # Use develop's version (already in HEAD)
              git checkout --ours version.properties
              git add version.properties
            else
              echo "‚ö†Ô∏è Main version is ahead or equal. This shouldn't happen. Manual resolution needed."
              git merge --abort
              exit 1
            fi
          
            # Check if there are other conflicts
            if git status | grep -q "Unmerged paths"; then
              echo "‚ö†Ô∏è Other merge conflicts exist beyond version.properties. Creating PR for manual resolution."
              # We'll create PR with remaining conflicts
            else
              # Only version.properties had conflicts, complete the merge
              git commit --no-edit || echo "Merge already committed"
              MERGE_FAILED=false
            fi
          elif [ "$MERGE_FAILED" = true ]; then
            echo "‚ö†Ô∏è Merge conflicts in files other than version.properties. Creating PR for manual resolution."
          fi
          
          # Read version.properties to calculate the next version
          # Only proceed with version bump if merge was successful (no unresolved conflicts)
          if git status | grep -q "Unmerged paths"; then
            echo "‚ö†Ô∏è Unresolved conflicts exist. Skipping version bump. PR will be created for manual resolution."
          else
            MAJOR=$(grep '^versionMajor=' version.properties | cut -d'=' -f2 || echo "0")
            MINOR=$(grep '^versionMinor=' version.properties | cut -d'=' -f2 || echo "0")
            PATCH=$(grep '^versionPatch=' version.properties | cut -d'=' -f2 || echo "0")
            IS_SNAPSHOT=$(grep '^versionSnapshot=' version.properties | cut -d'=' -f2 || echo "false")

            echo "Merged version state: $MAJOR.$MINOR.$PATCH (Snapshot: $IS_SNAPSHOT)"
          
            # Validate that MAJOR, MINOR, and PATCH are valid integers
            if ! [[ "$MAJOR" =~ ^[0-9]+$ ]] || ! [[ "$MINOR" =~ ^[0-9]+$ ]] || ! [[ "$PATCH" =~ ^[0-9]+$ ]]; then
              echo "‚ùå Error: Invalid version properties. MAJOR=$MAJOR, MINOR=$MINOR, PATCH=$PATCH"
              exit 1
            fi

            # Bump logic: If we just merged a Release (no snapshot), we prepare the next dev cycle
            if [ "$IS_SNAPSHOT" = "false" ]; then
              NEW_MINOR=$((MINOR + 1))
              NEW_PATCH=0
          
              sed -i "s/^versionMinor=.*/versionMinor=$NEW_MINOR/" version.properties
              sed -i "s/^versionPatch=.*/versionPatch=$NEW_PATCH/" version.properties
              sed -i "s/^versionSnapshot=.*/versionSnapshot=true/" version.properties
          
              echo "üöÄ Bumped to next development version: $MAJOR.$NEW_MINOR.$NEW_PATCH-SNAPSHOT"
          
              # Commit the bump
              git add version.properties
              git commit -m "chore: bump version to next minor snapshot [skip ci]" || echo "Nothing to commit"
            else
              echo "‚ÑπÔ∏è Main was already a snapshot or logic skipped. No bump needed."
            fi
          fi

          # Push the sync branch
          git push origin $SYNC_BRANCH

          # Create the Pull Request to develop
          gh pr create \
            --base develop \
            --head $SYNC_BRANCH \
            --title "Sync: Backmerge main to develop" \
            --body "Automated PR to sync release changes and bump version on develop. Please review and merge." \
            --label "sync"
